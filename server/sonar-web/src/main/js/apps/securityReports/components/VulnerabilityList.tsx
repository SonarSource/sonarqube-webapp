/*
 * SonarQube
 * Copyright (C) 2009-2018 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
import * as React from 'react';
import { Link } from 'react-router';
import { translate } from '../../../helpers/l10n';
import { SecurityHotspot, Component, BranchLike } from '../../../app/types';
import Rating from '../../../components/ui/Rating';
import { getComponentIssuesUrl } from '../../../helpers/urls';
import { getBranchLikeQuery } from '../../../helpers/branches';
import HelpTooltip from '../../../components/controls/HelpTooltip';
import VulnerabilityIcon from '../../../components/icons-components/VulnerabilityIcon';
import SecurityHotspotIcon from '../../../components/icons-components/SecurityHotspotIcon';
import {
  renderOwaspTop10Category,
  renderSansTop25Category,
  renderCWECategory,
  Standards
} from '../utils';

interface Props {
  branchLike?: BranchLike;
  component: Component;
  findings: Array<SecurityHotspot>;
  showCWE: boolean;
  type: 'owaspTop10' | 'sansTop25' | 'cwe';
}

interface State {
  standards: Standards;
}

export default class VulnerabilityList extends React.PureComponent<Props, State> {
  mounted = false;
  state: State = { standards: { owaspTop10: {}, sansTop25: {}, cwe: {} } };

  componentDidMount() {
    this.mounted = true;
    this.loadStandards();
  }

  componentWillUnmount() {
    this.mounted = false;
  }

  loadStandards = () => {
    import('../../../helpers/standards.json')
      .then(x => x.default)
      .then(
        ({ owaspTop10, sansTop25, cwe }: Standards) => {
          if (this.mounted) {
            this.setState({ standards: { owaspTop10, sansTop25, cwe } });
          }
        },
        () => {}
      );
  };

  getName(finding: SecurityHotspot, type: 'owaspTop10' | 'sansTop25' | 'cwe') {
    const category = finding.category || finding.cwe || 'unknown';
    const renderers = {
      owaspTop10: renderOwaspTop10Category,
      sansTop25: renderSansTop25Category,
      cwe: renderCWECategory
    };
    return (
      <>
        {renderers[type](this.state.standards, category)}
        {this.state.standards[type][category] &&
          this.state.standards[type][category].description && (
            <HelpTooltip
              className="spacer-left"
              overlay={this.state.standards[type][category].description}
            />
          )}
      </>
    );
  }

  renderFinding(finding: SecurityHotspot, isCWE?: boolean): React.ReactFragment {
    const { branchLike, component, type } = this.props;
    const params: { [name: string]: string | undefined } = {
      ...getBranchLikeQuery(branchLike),
      types: 'SECURITY_HOTSPOT'
    };
    params[type] = finding.category || finding.cwe;

    const subFindings =
      this.props.showCWE && finding.distribution
        ? finding.distribution.map(f => this.renderFinding(f, true))
        : null;

    return (
      <React.Fragment key={finding.category || finding.cwe}>
        <tr>
          {isCWE && <td />}
          <td className="nowrap" colSpan={isCWE ? 1 : 2}>
            <div className="display-inline-flex-center">
              {this.getName(finding, isCWE ? 'cwe' : type)}
            </div>
          </td>
          <td>
            <div className="display-inline-flex-center">
              <Link
                to={getComponentIssuesUrl(component.key, { ...params, types: 'VULNERABILITY' })}>
                {finding.vulnerabilities}
              </Link>
              <Link
                className="link-no-underline spacer-left"
                to={getComponentIssuesUrl(component.key, { ...params, types: 'VULNERABILITY' })}>
                <Rating value={finding.vulnerabilityRating || 1} />
              </Link>
            </div>
          </td>
          <td>
            <Link
              className="spacer-right"
              to={getComponentIssuesUrl(component.key, {
                ...params,
                types: 'SECURITY_HOTSPOT',
                resolved: 'false',
                statuses: 'OPEN'
              })}>
              {finding.openSecurityHotspots}
            </Link>
          </td>
          <td>
            <Link
              className="spacer-right"
              to={getComponentIssuesUrl(component.key, {
                ...params,
                types: 'SECURITY_HOTSPOT',
                resolutions: 'FIXED'
              })}>
              {finding.toReviewSecurityHotspots}
            </Link>
          </td>
          <td>
            <Link
              className="spacer-right"
              to={getComponentIssuesUrl(component.key, {
                ...params,
                types: 'SECURITY_HOTSPOT',
                resolutions: 'WONTFIX'
              })}>
              {finding.wontFixSecurityHotspots}
            </Link>
          </td>
        </tr>
        {subFindings}
      </React.Fragment>
    );
  }

  render() {
    return (
      <div className="boxed-group boxed-group-inner spacer-top">
        <table className="data zebra">
          <thead>
            <tr>
              <th className="security-category-column" colSpan={2}>
                {translate('security_reports.list.categories')}
              </th>
              <th className="security-result-column">
                <div className="display-inline-flex-center">
                  <VulnerabilityIcon className="spacer-right" />{' '}
                  {translate('security_reports.list.vulnerabilities')}
                </div>
              </th>
              <th colSpan={3}>
                <div className="display-inline-flex-center">
                  <SecurityHotspotIcon className="spacer-right" />{' '}
                  {translate('security_reports.list.hotspots')}
                </div>
              </th>
            </tr>
            <tr className="subheader">
              <th colSpan={3} />
              <th className="security-result-column">{translate('security_reports.line.open')}</th>
              <th className="security-result-column">
                {translate('security_reports.line.in_review')}
              </th>
              <th className="security-result-column">
                {translate('security_reports.line.wont_fix')}
              </th>
            </tr>
          </thead>
          <tbody>{this.props.findings.map(finding => this.renderFinding(finding))}</tbody>
        </table>
      </div>
    );
  }
}
